"use client";

import { useState, useEffect } from "react";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";
import { getDemandForecast, getUploadedFiles } from "../services/api";
import LoadingSpinner from "../components/LoadingSpinner";
import ErrorMessage from "../components/ErrorMessage";
import { useNavigate } from "react-router-dom";
import "./Forecast.css";

const Forecast = () => {
  const [forecastData, setForecastData] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState("");
  const [selectedModel, setSelectedModel] = useState("xgboost");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [retryCount, setRetryCount] = useState(0);
  const navigate = useNavigate();

  useEffect(() => {
    const fetchForecastData = async () => {
      try {
        const uploadedFiles = await getUploadedFiles(); // <- ch·∫Øc ch·∫Øn ch·ªù xong
        if (!uploadedFiles || uploadedFiles.length === 0) {
          navigate("/upload");
          return;
        }
  
        setLoading(true);
        setError(null);
  
        const response = await getDemandForecast();
        let allResults = [];
  
        if (Array.isArray(response.data)) {
          allResults = response.data.filter((cat) => cat.status === "success");
        } else if (response.data?.status === "success") {
          allResults = [{ ...response.data, category: response.data.category || "T·ªïng th·ªÉ" }];
        }
  
        if (allResults.length === 0) throw new Error("Kh√¥ng c√≥ danh m·ª•c n√†o ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ d·ª± b√°o.");
  
        setForecastData(allResults);
        setSelectedCategory(allResults[0].category);
        setLoading(false);
      } catch (err) {
        console.error("Error fetching forecast data:", err);
        setError(err.message || "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu d·ª± b√°o. Vui l√≤ng th·ª≠ l·∫°i sau.");
        setLoading(false);
        if (retryCount < 3) {
          setTimeout(() => setRetryCount((prev) => prev + 1), 5000);
        }
      }
    };
  
    fetchForecastData();
  }, [retryCount, navigate]); // gi·ªØ nguy√™n, nh∆∞ng tr√°nh g·ªçi khi ch∆∞a c√≥ file
  
  const handleRetry = () => setRetryCount((prev) => prev + 1);

  const currentCategoryData = forecastData.find((cat) => cat.category === selectedCategory);

  const historicalData = currentCategoryData?.chart_data.filter((item) => item.type === "Th·ª±c t·∫ø") || [];
  const forecastedXGB = currentCategoryData?.chart_data.filter((item) => item.type === "XGBoost") || [];
  const forecastedARIMA = currentCategoryData?.chart_data.filter((item) => item.type === "ARIMA") || [];

  const currentForecast =
    selectedModel === "xgboost"
      ? forecastedXGB
      : selectedModel === "arima"
      ? forecastedARIMA
      : [...forecastedXGB];

  const firstForecast = currentForecast[0];
  const lastActual = historicalData[historicalData.length - 1];

  const forecastChange =
    lastActual && firstForecast
      ? (((firstForecast.orders - lastActual.orders) / lastActual.orders) * 100).toFixed(1)
      : 0;

  const avgForecast =
    currentForecast.length > 0
      ? (
          currentForecast.reduce((sum, item) => sum + (item.orders || 0), 0) / currentForecast.length
        ).toFixed(0)
      : 0;

  const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
      return (
        <div className="custom-tooltip">
          <p className="tooltip-label">{`Th√°ng: ${label}`}</p>
          <p className="tooltip-value">{`${payload[0].name}: ${payload[0].value.toLocaleString()}`}</p>
          {payload[0].payload.type && <p className="tooltip-type">{`Lo·∫°i: ${payload[0].payload.type}`}</p>}
        </div>
      );
    }
    return null;
  };

  if (loading)
    return (
      <LoadingSpinner message="ƒêang t·∫£i d·ªØ li·ªáu d·ª± b√°o. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t n·∫øu d·ªØ li·ªáu v·ª´a ƒë∆∞·ª£c t·∫£i l√™n." />
    );

  if (error)
    return (
      <div className="error-with-retry">
        <ErrorMessage message={error} />
        <button className="retry-button" onClick={handleRetry}>
          Th·ª≠ l·∫°i
        </button>
        <p className="retry-note">L∆∞u √Ω: Sau khi t·∫£i l√™n d·ªØ li·ªáu m·ªõi, h·ªá th·ªëng c·∫ßn th·ªùi gian ƒë·ªÉ x·ª≠ l√Ω v√† t√≠nh to√°n d·ª± b√°o.</p>
      </div>
    );

  return (
    <div className="forecast">
      <h1 className="page-title">D·ª± b√°o nhu c·∫ßu</h1>

      <div className="selectors">
        <div className="category-selector">
          <label>Ch·ªçn danh m·ª•c: </label>
          <select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>
            {forecastData.map((cat) => (
              <option key={cat.category} value={cat.category}>
                {cat.category}
              </option>
            ))}
          </select>
        </div>

        <div className="model-selector">
          <label>Ch·ªçn m√¥ h√¨nh d·ª± b√°o: </label>
          <select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)}>
            <option value="xgboost">XGBoost</option>
            <option value="arima">ARIMA</option>
            <option value="both">So s√°nh c·∫£ 2 m√¥ h√¨nh</option>
          </select>
        </div>
      </div>

      {/* Th·ªëng k√™ d·ª± b√°o */}
      <div className="stats-grid">
        <div className="stat-card">
          <div className="stat-icon forecast-icon">üìà</div>
          <div className="stat-info">
            <div className="stat-title">D·ª± b√°o th√°ng t·ªõi</div>
            <div className="stat-value">{firstForecast?.orders?.toLocaleString() || "-"}</div>
            <div className={`stat-change ${forecastChange >= 0 ? "positive" : "negative"}`}>
              {forecastChange >= 0 ? "‚Üë" : "‚Üì"} {Math.abs(forecastChange)}%
            </div>
          </div>
        </div>

        <div className="stat-card">
          <div className="stat-icon average-icon">üìä</div>
          <div className="stat-info">
            <div className="stat-title">Trung b√¨nh 6 th√°ng t·ªõi</div>
            <div className="stat-value">{Number(avgForecast).toLocaleString()}</div>
            <div className="stat-detail">ƒë∆°n h√†ng/th√°ng</div>
          </div>
        </div>
      </div>

      {/* Bi·ªÉu ƒë·ªì */}
      <div className="card">
        <div className="card-header">
          <h2 className="card-title">Bi·ªÉu ƒë·ªì d·ª± b√°o</h2>
        </div>
        <div className="card-body">
          <ResponsiveContainer width="100%" height={400}>
            <LineChart data={[...historicalData, ...forecastedXGB, ...forecastedARIMA]}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="month" allowDuplicatedCategory={false} tickFormatter={(value) => value.split("-")[1]} />
              <YAxis />
              <Tooltip content={<CustomTooltip />} />
              <Legend />
              <Line
                type="monotone"
                dataKey="orders"
                stroke="#2196f3"
                name="Th·ª±c t·∫ø"
                strokeWidth={2}
                dot={{ r: 4 }}
                activeDot={{ r: 6 }}
                connectNulls
                animationDuration={1000}
                data={historicalData}
              />
              {(selectedModel === "xgboost" || selectedModel === "both") && (
                <Line
                  type="monotone"
                  dataKey="orders"
                  stroke="#ff9800"
                  name="XGBoost"
                  strokeWidth={2}
                  strokeDasharray="5 5"
                  dot={{ r: 4 }}
                  connectNulls
                  animationDuration={1000}
                  data={forecastedXGB}
                />
              )}
              {(selectedModel === "arima" || selectedModel === "both") && (
                <Line
                  type="monotone"
                  dataKey="orders"
                  stroke="#4caf50"
                  name="ARIMA"
                  strokeWidth={2}
                  strokeDasharray="6 3"
                  dot={{ r: 4 }}
                  connectNulls
                  animationDuration={1000}
                  data={forecastedARIMA}
                />
              )}
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* B·∫£ng chi ti·∫øt */}
      <div className="card">
        <div className="card-header">
          <h2 className="card-title">Chi ti·∫øt d·ª± b√°o theo th√°ng</h2>
        </div>
        <div className="card-body">
          <div className="table-container">
            <table className="forecast-table">
              <thead>
                <tr>
                  <th>Th√°ng</th>
                  <th>S·ªë ƒë∆°n h√†ng d·ª± b√°o</th>
                  <th>So v·ªõi th√°ng tr∆∞·ªõc</th>
                </tr>
              </thead>
              <tbody>
                {currentForecast.map((item, index) => {
                  const prev = currentForecast[index - 1]?.orders || item.orders;
                  const diff = prev && prev !== 0 ? (((item.orders - prev) / prev) * 100).toFixed(1) : 0;
                  return (
                    <tr key={index}>
                      <td>{item.month}</td>
                      <td>{item.orders != null ? item.orders.toLocaleString() : "-"}</td>
                      <td className={diff >= 0 ? "positive" : "negative"}>
                        {diff > 0 ? "+" : ""}{diff}%
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {currentCategoryData?.mae_rmse_comparison && (
  <div className="card">
    <div className="card-header">
      <h2 className="card-title">So s√°nh ƒë·ªô ch√≠nh x√°c m√¥ h√¨nh</h2>
    </div>
    <div className="card-body">
      <table className="forecast-table">
        <thead>
          <tr>
            <th>M√¥ h√¨nh</th>
            <th>MAE</th>
            <th>RMSE</th>
          </tr>
        </thead>
        <tbody>
  {["xgboost", "arima"].map((model) => {
    const mae = currentCategoryData.mae_rmse_comparison[model].mae;
    const rmse = currentCategoryData.mae_rmse_comparison[model].rmse;

    const betterMaeModel =
      currentCategoryData.mae_rmse_comparison.xgboost.mae <
      currentCategoryData.mae_rmse_comparison.arima.mae
        ? "xgboost"
        : "arima";

    const betterRmseModel =
      currentCategoryData.mae_rmse_comparison.xgboost.rmse <
      currentCategoryData.mae_rmse_comparison.arima.rmse
        ? "xgboost"
        : "arima";

    return (
<tr key={model}>
  <td style={{ fontWeight: "600" }}>{model.toUpperCase()}</td>

  <td className={model === betterMaeModel ? "highlight-better" : "highlight-worse"}>
    {mae.toLocaleString()}
    {model === betterMaeModel && (
      <span className="ml-1" title="Ch·ªâ s·ªë MAE t·ªët h∆°n">üëç</span>
    )}
  </td>

  <td className={model === betterRmseModel ? "highlight-better" : "highlight-worse"}>
    {rmse.toLocaleString()}
    {model === betterRmseModel && (
      <span className="ml-1" title="Ch·ªâ s·ªë RMSE t·ªët h∆°n">üëç</span>
    )}
  </td>
</tr>

    );
  })}
</tbody>

      </table>
    </div>
  </div>
)}

    </div>
  );
};

export default Forecast;
